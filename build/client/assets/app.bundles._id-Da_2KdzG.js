import{r,j as e}from"./index-BXFZJKZ8.js";import{u as me,S as q,R as F,T as O,a as L,d as ge,g as xe,v as ye}from"./volume-brackets-BsJ0wB5Q.js";import{u as be,a as je,b as fe,c as Te,d as Se}from"./components-B2MXwJ-S.js";import{P as Ce,B as d,C as S,T as a,a as C,I as Q,b as v}from"./Page-D9pdNdHS.js";import{T as ke}from"./TitleBar-DFMSJ8Yc.js";import{L as A}from"./Layout-BW6TgK73.js";import{C as E}from"./EmptySearchResult-B5Jp3ieX.js";import{B as X}from"./Banner-BiM8hRvP.js";import"./context-BusKBsRw.js";import"./banner-context-RZ1829w2.js";function we(){const{bundle:i,richProducts:H,richCollections:U}=be(),D=me(),G=je(),$=fe(),J=Te(),x=Se(),[P,z]=r.useState(i.title),[p,K]=r.useState(i.type),[b,Y]=r.useState(i.discountType||"PERCENTAGE"),[N,Z]=r.useState(i.discountValue?i.discountValue.toString():""),[w,ee]=r.useState(i.stacksWithProductDiscounts??!0),[V,te]=r.useState(i.stacksWithOrderDiscounts??!0),[W,se]=r.useState(i.stacksWithShippingDiscounts??!0),[k,ne]=r.useState(H||[]),[R,ie]=r.useState(i.targetQuantity?i.targetQuantity.toString():"3"),[j,ae]=r.useState(U||[]),[c,y]=r.useState(()=>{if(!i.tiers||i.tiers.length===0)return[{quantity:"2",uncapped:!0,discountType:"PERCENTAGE",discountValue:"10"}];const t=[...i.tiers].sort((n,l)=>n.quantity-l.quantity);return t.map((n,l)=>({quantity:n.quantity.toString(),uncapped:l===t.length-1&&n.quantityMax==null,discountType:n.discountType,discountValue:n.discountValue.toString()}))}),_=J.state==="submitting",oe=x==null?void 0:x.tierErrors,[re,f]=r.useState([]),T=oe??re,ce=T&&T.length>0,le=()=>{if(p==="VOLUME"){const t=ye(c);if(t.length>0){f(t);return}f([])}pe()},ue=async()=>{const t=await D.resourcePicker({type:"product",multiple:!0,selectionIds:k.map(n=>({id:n.id}))});t&&ne(t)},de=async()=>{const t=await D.resourcePicker({type:"collection",multiple:!0,selectionIds:j.map(n=>({id:n.id}))});t&&ae(t)},pe=()=>{const t=new FormData;t.append("title",P),p==="VOLUME"?t.append("tiers",JSON.stringify(c)):(t.append("discountType",b),t.append("discountValue",N)),p==="MIX_MATCH"&&t.append("targetQuantity",R),t.append("type",p),t.append("stacksWithProductDiscounts",w.toString()),t.append("stacksWithOrderDiscounts",V.toString()),t.append("stacksWithShippingDiscounts",W.toString()),k.forEach(n=>{t.append("productIds[]",n.id)}),j.forEach(n=>{t.append("collectionIds[]",n.id)}),G(t,{method:"post"})};return e.jsxs(Ce,{backAction:{content:"Bundles",onAction:()=>$("/app")},title:`Edit: ${i.title}`,children:[e.jsx(ke,{title:`Edit: ${i.title}`,children:e.jsx("button",{variant:"primary",onClick:le,disabled:_,children:_?"Saving...":"Save changes"})}),e.jsx(d,{gap:"500",children:e.jsxs(A,{children:[e.jsx(A.Section,{children:e.jsxs(d,{gap:"500",children:[e.jsx(S,{children:e.jsxs(d,{gap:"400",children:[e.jsx(a,{variant:"headingMd",as:"h2",children:"Bundle details"}),(x==null?void 0:x.error)&&e.jsx(a,{tone:"critical",as:"p",children:x.error}),e.jsx(C,{label:"Bundle title",value:P,onChange:z,autoComplete:"off",helpText:"Internal name for your reference."}),e.jsx(q,{label:"Bundle type",options:[{label:"Frequently Bought Together (FBT)",value:"FBT"},{label:"Volume Pricing (Quantity Breaks)",value:"VOLUME"},{label:"Mix & Match",value:"MIX_MATCH"},{label:"Classic Bundle",value:"CLASSIC"}],value:p,onChange:K}),p==="MIX_MATCH"&&e.jsx(C,{label:"Required Items (Target Quantity)",type:"number",value:R,onChange:ie,autoComplete:"off",helpText:"How many items must the customer choose from the pool below to unlock the deal?"})]})}),e.jsx(S,{children:e.jsxs(d,{gap:"400",children:[e.jsx(a,{variant:"headingMd",as:"h2",children:"Products & Collections"}),k.length>0?e.jsx(F,{resourceName:{singular:"product",plural:"products"},items:k,renderItem:t=>{var g,h;const{id:n,title:l,images:u}=t,s=e.jsx(O,{source:((g=u[0])==null?void 0:g.originalSrc)||"https://cdn.shopify.com/s/files/1/0533/2089/files/placeholder-images-image_large.png",alt:((h=u[0])==null?void 0:h.altText)||l});return e.jsx(L,{id:n,media:s,onClick:()=>{},children:e.jsx(a,{variant:"bodyMd",fontWeight:"bold",as:"h3",children:l})})}}):e.jsx(a,{as:"p",tone:"subdued",children:"No products selected."}),p==="MIX_MATCH"&&j.length>0&&e.jsx(F,{resourceName:{singular:"collection",plural:"collections"},items:j,renderItem:t=>{const{id:n,title:l,image:u}=t,s=e.jsx(O,{source:(u==null?void 0:u.originalSrc)||"https://cdn.shopify.com/s/files/1/0533/2089/files/placeholder-images-image_large.png",alt:(u==null?void 0:u.altText)||l});return e.jsx(L,{id:n,media:s,onClick:()=>{},children:e.jsxs(a,{variant:"bodyMd",fontWeight:"bold",as:"h3",children:[l," (Collection)"]})})}}),p==="MIX_MATCH"&&j.length===0&&e.jsx(a,{as:"p",tone:"subdued",children:"No collections selected."}),e.jsxs(Q,{gap:"300",children:[e.jsx(v,{onClick:ue,children:"Select products"}),p==="MIX_MATCH"&&e.jsx(v,{onClick:de,children:"Select collections"})]})]})}),e.jsx(S,{children:e.jsxs(d,{gap:"400",children:[e.jsx(a,{variant:"headingMd",as:"h2",children:"Combinations"}),e.jsxs(d,{gap:"200",children:[e.jsx(E,{label:"Product discounts",checked:w,onChange:ee}),e.jsx(E,{label:"Order discounts",checked:V,onChange:te}),e.jsx(E,{label:"Shipping discounts",checked:W,onChange:se})]}),e.jsx(a,{variant:"bodySm",tone:"subdued",as:"p",children:"Allow this bundle discount to be combined with other product, order, or shipping discounts at checkout."})]})})]})}),e.jsx(A.Section,{variant:"oneThird",children:p!=="VOLUME"?e.jsx(S,{children:e.jsxs(d,{gap:"400",children:[e.jsx(a,{variant:"headingMd",as:"h2",children:"Discount"}),e.jsx(q,{label:"Discount type",options:[{label:"Percentage (%)",value:"PERCENTAGE"},{label:"Fixed amount off",value:"FIXED_AMOUNT"},{label:"Set fixed price",value:"FIXED_PRICE"}],value:b,onChange:Y}),e.jsx(C,{label:"Discount value",type:"number",value:N,onChange:Z,autoComplete:"off",suffix:b==="PERCENTAGE"?"%":void 0,helpText:b==="FIXED_PRICE"?"The exact total price the customer will pay for all items combined.":b==="FIXED_AMOUNT"?"The exact dollar amount to deduct from the total price of the items.":"The percentage to discount from the total price of the items."})]})}):e.jsx(S,{children:e.jsxs(d,{gap:"400",children:[e.jsx(a,{variant:"headingMd",as:"h2",children:"Volume Tiers"}),e.jsxs(X,{tone:"info",title:"How quantity brackets work",children:[e.jsx("p",{children:"Quantity brackets are set automatically. Enter the minimum quantity for each tier (e.g., 2, 3, 6). Brackets will be: 2-2 items, 3-5 items, 6+ items. Each quantity range gets exactly one discount."}),e.jsx("p",{children:"Example: Buy 2 = 10%, Buy 3-5 = 15%, Buy 6+ = 20%"})]}),ce&&e.jsx(X,{tone:"critical",title:"Fix bracket errors",children:"Quantities must increase (e.g., 2, 3, 6). Check the fields below."}),(()=>{const t=[...c].map((s,g)=>({...s,originalIndex:g})).sort((s,g)=>(parseInt(s.quantity)||0)-(parseInt(g.quantity)||0)),n=t.filter(s=>!isNaN(parseInt(s.quantity))&&parseInt(s.quantity)>=1).map(s=>({quantity:parseInt(s.quantity),uncapped:s.uncapped})),l=ge(n),u=new Map(l.map(s=>[s.min,s]));return t.map((s,g)=>{const h=s.originalIndex,I=parseInt(s.quantity),M=!isNaN(I)&&I>=1?u.get(I):null,he=M?xe(M.min,M.max):"—",B=T==null?void 0:T.find(m=>m.index===h);return e.jsxs(d,{gap:"200",children:[e.jsxs(a,{fontWeight:"bold",as:"p",children:["Tier ",g+1]}),e.jsxs(Q,{gap:"300",blockAlign:"start",children:[e.jsx(C,{label:"Buy Qty",type:"number",value:s.quantity,onChange:m=>{const o=[...c];o[h].quantity=m,y(o),f([])},autoComplete:"off",helpText:"Minimum quantity for this tier. Must be higher than the tier above.",error:B==null?void 0:B.message}),e.jsxs(d,{gap:"100",children:[e.jsx(a,{as:"p",variant:"bodySm",tone:"subdued",children:"Bracket"}),e.jsx(a,{as:"p",fontWeight:"semibold",children:he||"—"})]}),e.jsx(C,{label:"Discount",type:"number",value:s.discountValue,onChange:m=>{const o=[...c];o[h].discountValue=m,y(o)},autoComplete:"off",connectedLeft:e.jsx(q,{label:"Type",labelHidden:!0,options:[{label:"%",value:"PERCENTAGE"},{label:"$",value:"FIXED_AMOUNT"}],value:s.discountType,onChange:m=>{const o=[...c];o[h].discountType=m,y(o)}})})]}),g===t.length-1&&e.jsx(E,{label:`Apply this discount to all quantities ${s.quantity||"?"} and above`,helpText:"Recommended for your best discount tier.",checked:s.uncapped??!0,onChange:m=>{const o=[...c];o[h].uncapped=m,y(o)}}),e.jsx(v,{tone:"critical",onClick:()=>{y(c.filter((m,o)=>o!==h)),f([])},children:"Remove Tier"})]},h)})})(),e.jsxs(d,{gap:"100",children:[e.jsx(v,{onClick:()=>{const t=c.length>0?Math.max(...c.map(n=>parseInt(n.quantity)||0),0)+1:2;y([...c,{quantity:String(t),uncapped:!0,discountType:"PERCENTAGE",discountValue:""}]),f([])},children:"Add tier"}),e.jsx(a,{as:"p",variant:"bodySm",tone:"subdued",children:"Add another tier. New tier's minimum must be higher than the last."})]})]})})})]})})]})}export{we as default};
